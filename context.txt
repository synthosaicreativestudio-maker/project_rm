Техническое задание: Агрегатор нейросетей в Telegram (Web App)
1. Общая архитектура и логика взаимодействия
Продукт представляет собой гибридное приложение:
Telegram Bot (Standard API): Отвечает за вход, уведомления, доставку готового контента и быстрые действия (Inline-кнопки).
Telegram Mini App (Web App): Основной графический интерфейс (Frontend), открывающийся внутри Telegram. Служит для настройки параметров генерации, выбора моделей и управления профилем.
Backend: Оркестратор запросов к API нейросетей, биллинг, база данных пользователей и истории.
Основной флоу (User Flow):
Пользователь открывает Web App → Настраивает параметры → Нажимает «Генерировать».
Web App отправляет запрос на Backend.
Web App закрывается (или сворачивается), а Backend ставит задачу в очередь.
Когда генерация готова, Бот присылает результат (картинку/текст/видео) в чат с пользователем.
2. Функциональный блок: Telegram Bot (Chat Interface)
Этот интерфейс служит для онбординга и получения результатов.
2.1. Команды и Меню
/start — Регистрация пользователя в БД (сохранение chat_id, username), проверка реферальной ссылки (Deep linking). Приветственное сообщение с кнопкой запуска Web App.
Menu Button — Постоянная кнопка слева от поля ввода, запускающая Web App (web_app_url).
2.2. Обработка результатов (Output)
Текст: Сообщения приходят в формате Markdown. Поддержка стриминга (постепенное появление текста) желательна, но в рамках ТГ сложна (обычно обновлением сообщения).
Изображения/Видео/Аудио: Отправка файлов с превью.
Inline-кнопки под результатом:
Для Midjourney: Кнопки U1-U4 (Upscale), V1-V4 (Variation), Zoom Out, Pan. Нажатие отправляет callback на бэкенд, который инициирует новую задачу.
Кнопка «Повторить» (Rerun) с теми же параметрами.
Кнопка «Скачать» (получение документа без сжатия).
3. Функциональный блок: Web App (Frontend)
SPA (Single Page Application), написанное на React/Vue/Next.js. Интерфейс должен быть адаптирован под мобильные устройства (Mobile First).
3.1. Главный экран и Навигация
Таб-бар (нижнее или верхнее меню): Переключение между режимами:
Чат (LLM)
Изображения
Видео
Аудио
Профиль/Кошелек
3.2. Модуль «Текстовый Чат» (LLM)
Выбор модели: Выпадающий список (Dropdown) с иконками (GPT-4o, Claude 3.5, Gemini).
Интерфейс диалога: Классический чат (пузыри сообщений). История хранится локально в сессии или подгружается с бэкенда.
Вложения: Кнопка «скрепка» для загрузки файлов (PDF, DOCX, TXT) или изображений (для Vision моделей). Файл уходит на бэкенд, парсится, текст скармливается модели в контекст.
Роли (System Prompts): Библиотека пресетов. При выборе «Копирайтер» в тело запроса к API скрыто добавляется системный промпт: "Ты профессиональный копирайтер...".
Управление контекстом: Кнопка «Очистить историю» (сброс thread_id или массива сообщений).
3.3. Модуль «Генерация Изображений» (Image Gen)
Это сложная форма с валидацией полей.
Input: Текстовое поле для промпта (Multiliner).
Выбор модели: Midjourney, DALL-E 3, Stable Diffusion, Flux.
Настройки (UI Controls):
Aspect Ratio: Визуальные прямоугольники (16:9, 1:1, 9:16, 4:3).
Styles: Сетка карточек с примерами стилей (Anime, Photo, Cyberpunk). При выборе к промпту добавляются ключевые слова.
Advanced Settings (Accordion):
Negative Prompt (исключить объекты).
Chaos/Stylize (ползунки 0-100).
Seed (числовое поле).
Референс (Image-to-Image): Uploader для загрузки картинки-исходника.
3.4. Модуль «Видео и Анимация»
Режимы: Табы «Text-to-Video» и «Image-to-Video».
Text-to-Video: Поле ввода промпта + выбор модели (Runway, Kling, Luma).
Image-to-Video: Загрузка изображения (Drag & Drop или выбор из галереи).
Параметр: Motion Bucket (сила движения, слайдер 1-10).
Параметр: Camera Control (Zoom In/Out, Pan).
3.5. Модуль «Профиль и Баланс»
Отображение баланса: Текущее количество токенов/кредитов.
Тарифная сетка: Карточки с пакетами токенов.
История операций: Список списаний (дата, модель, стоимость).
Реферальная программа: Отображение ссылки https://t.me/botname?start=ref123, статистика приглашенных.
4. Backend и Интеграции (Server Side)
4.1. Управление API (API Gateway)
Бэкенд должен уметь переключаться между провайдерами (Load Balancing) и управлять ключами.
Интеграции:
OpenAI API: Для GPT-4, DALL-E, Whisper (STT), TTS.
Anthropic API: Для Claude.
Midjourney: Официального API нет. Требуется использование прокси-сервисов (например, GoAPI, UserAPI) или self-hosted решения на базе Discord-ботов (эмуляция действий пользователя в Discord). Это самая сложная часть.
Suno/Runway/Pika: Использование неофициальных API или Reverse Engineering решений.
Нормализация запросов: Приведение запросов от фронтенда к единому формату для разных нейросетей.
4.2. Биллинг и Токеномика
Внутренняя валюта: 1 кредит = X рублей.
Динамическое ценообразование:
GPT-3.5 = 1 кредит.
GPT-4 = 10 кредитов.
Midjourney = 15 кредитов.
Стоимость должна проверяться на бэкенде перед отправкой запроса.
Платежные шлюзы:
Интеграция с Telegram Stars (для официальных товаров).
Российские платежные системы (Yookassa, Robokassa, CloudPayments) — реализация через открытие ссылки на оплату (Invoice Link).
Криптопроцессинг (Cryptomus / Wallet Pay).
4.3. Очереди задач (Task Queue)
Генерация видео и картинок занимает от 10 секунд до 5 минут.
Использование Redis + Celery (Python) или BullMQ (Node.js).
Пользователь не должен ждать с открытым окном. Задача ставится в очередь -> Бот уведомляет через Webhook, когда статус меняется на COMPLETED.
4.4. База данных
Users: ID, Username, Balance, Ref_code, Created_at.
Generations: User_ID, Model, Prompt, Result_URL, Status, Cost, Timestamp. (Важно для истории и кнопки «Повторить»).
Transactions: History of payments and spendings.
5. Админ-панель (Admin UI)
Отдельный веб-интерфейс для владельца.
Дашборд: Статистика DAU/MAU, выручка, расход токенов API.
Управление пользователями: Начисление баланса вручную, бан.
Рассылки: Отправка сообщений всем пользователям бота (с картинкой и кнопкой).
Настройка цен: Возможность менять стоимость генерации для разных моделей без изменения кода.
6. Нефункциональные требования
Безопасность: Валидация всех входящих данных. Защита от prompt injection (на уровне системных промптов).
Хранение медиа: Сгенерированные файлы (видео/фото) должны храниться в S3-совместимом хранилище (AWS S3, MinIO, Selectel Cloud), так как ссылки от нейросетей (особенно Midjourney) часто временные.
Масштабируемость: Возможность подключения дополнительных аккаунтов Discord (для Midjourney) при росте нагрузки.
Это описание можно передавать Team Lead или Senior разработчику для оценки сроков и стека технологий.
